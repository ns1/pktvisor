FROM debian:bullseye-slim AS cppbuild

ENV BUILD_DEPS "g++ cmake make git libpcap-dev pkgconf libmaxminddb-dev jq python3-pip python3-setuptools"

RUN \
    apt-get update && \
    apt-get install --yes --no-install-recommends ${BUILD_DEPS} && \
    pip3 install conan

RUN \
    mkdir /local && \
    cd /tmp && \
    git clone https://github.com/ns1/PcapPlusPlus.git && \
    cd /tmp/PcapPlusPlus && \
    ./configure-linux.sh --install-dir /local && \
    make libs -j 4 && \
    make install

COPY . /pktvisor-src/

WORKDIR /tmp/build
RUN \
    conan profile new --detect default && \
    conan profile update settings.compiler.libcxx=libstdc++11 default && \
    conan install /pktvisor-src
RUN \
    PKG_CONFIG_PATH=/local/lib/pkgconfig cmake -DCMAKE_BUILD_TYPE=RelWithDebInfo /pktvisor-src && \
    make pktvisord pktvisor-pcap -j 4

FROM golang:latest AS gobuild
COPY golang/ /src/
WORKDIR /src/
RUN go build -o pktvisor-cli cmd/pktvisor-cli/main.go

FROM debian:bullseye-slim AS runtime

ENV RUNTIME_DEPS "curl libpcap0.8 libmaxminddb0"

RUN \
    apt-get update && \
    apt-get install --yes --no-install-recommends ${RUNTIME_DEPS} && \
    rm -rf /var/lib/apt

COPY --from=cppbuild /tmp/build/bin/pktvisord /usr/local/sbin/pktvisord
COPY --from=cppbuild /tmp/build/bin/pktvisor-pcap /usr/local/sbin/pktvisor-pcap
COPY --from=gobuild /src/pktvisor-cli /usr/local/bin/pktvisor-cli
COPY docker/entry.sh /usr/local/bin/

ENTRYPOINT [ "entry.sh" ]

